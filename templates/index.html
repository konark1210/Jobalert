<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-2xl font-bold text-gray-800">Job Portal</h1>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Filter Section -->
        <div class="mb-6 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
                <label for="sheetFilter" class="block text-sm font-medium text-gray-700">Filter by Sheet</label>
                <select id="sheetFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="all">All Jobs</option>
                </select>
            </div>
            <div>
                <label for="companyFilter" class="block text-sm font-medium text-gray-700">Filter by Company</label>
                <select id="companyFilter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option value="all">All Companies</option>
                </select>
            </div>
        </div>

        <!-- Job Cards Container -->
        <div id="jobsContainer" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            <!-- Jobs will be dynamically inserted here -->
        </div>
    </div>

    <!-- Job Application Modal -->
    <div id="applicationModal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                        Apply for Job
                    </h3>
                    <div class="mt-2">
                        <p class="text-sm text-gray-500" id="modalJobDetails">
                        </p>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="confirmApply" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Apply
                    </button>
                    <button type="button" id="closeModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentJobs = {};
        let selectedJobId = null;
        let selectedSheetName = null;
        let selectedCompany = 'all';

        // Fetch jobs from the API
        async function fetchJobs() {
            try {
                const response = await fetch('/api/jobs');
                const data = await response.json();
                console.log('Fetched jobs data:', data); // Debug log
                currentJobs = data;
                
                // Populate sheet filter
                const sheetFilter = document.getElementById('sheetFilter');
                sheetFilter.innerHTML = '<option value="all">All Jobs</option>';
                Object.keys(data).forEach(sheet => {
                    sheetFilter.innerHTML += `<option value="${sheet}">${sheet}</option>`;
                });

                // Populate company filter
                populateCompanyFilter();

                // Initial display of all jobs
                displayJobs('all');
            } catch (error) {
                console.error('Error fetching jobs:', error);
                alert('Error loading jobs. Please check the console for details.');
            }
        }

        // Populate company filter with unique company names
        function populateCompanyFilter() {
            const companies = new Set();
            Object.values(currentJobs).forEach(jobs => {
                jobs.forEach(job => {
                    const company = job['Company Name'] || job['company_name'];
                    if (company) {
                        companies.add(company);
                    }
                });
            });

            const companyFilter = document.getElementById('companyFilter');
            companyFilter.innerHTML = '<option value="all">All Companies</option>';
            Array.from(companies).sort().forEach(company => {
                companyFilter.innerHTML += `<option value="${company}">${company}</option>`;
            });
        }

        // Display jobs based on selected sheet and company
        function displayJobs(sheetName) {
            const container = document.getElementById('jobsContainer');
            container.innerHTML = '';
            console.log('Displaying jobs for sheet:', sheetName, 'and company:', selectedCompany); // Debug log

            if (sheetName === 'all') {
                // Display all jobs from all sheets
                Object.entries(currentJobs).forEach(([sheet, jobs]) => {
                    console.log(`Processing ${jobs.length} jobs from sheet: ${sheet}`); // Debug log
                    jobs.forEach((job, index) => {
                        if (shouldDisplayJob(job)) {
                            const card = createJobCard(job, sheet);
                            container.appendChild(card);
                        }
                    });
                });
            } else {
                // Display jobs from specific sheet
                const jobs = currentJobs[sheetName] || [];
                console.log(`Processing ${jobs.length} jobs from sheet: ${sheetName}`); // Debug log
                jobs.forEach((job, index) => {
                    if (shouldDisplayJob(job)) {
                        const card = createJobCard(job, sheetName);
                        container.appendChild(card);
                    }
                });
            }
        }

        // Check if job should be displayed based on filters
        function shouldDisplayJob(job) {
            if (selectedCompany === 'all') return true;
            const company = job['Company Name'] || job['company_name'];
            return company === selectedCompany;
        }

        // Create a job card element
        function createJobCard(job, sheetName) {
            console.log('Creating card for job:', job); // Debug log
            
            const div = document.createElement('div');
            div.className = 'bg-white overflow-hidden shadow rounded-lg';
            
            // Function to safely get value from job object
            const getValue = (possibleKeys) => {
                for (const key of possibleKeys) {
                    if (job[key] !== undefined && job[key] !== null && job[key] !== '') {
                        return job[key];
                    }
                }
                return null;
            };

            // Get all relevant job information with fallbacks
            const title = getValue(['Title', 'Position', 'Role', 'JobTitle', 'Job Title', 'job_title']) || 'No Title';
            const company = getValue(['Company', 'Organization', 'Employer', 'Company Name', 'company_name']) || 'Company Not Specified';
            const location = getValue(['Location', 'Place', 'City', 'Area']) || 'Location Not Specified';
            const source = getValue(['Source File', 'Source']) || '';
            const description = getValue(['Description', 'Details', 'Job Description']) || '';
            const salary = getValue(['Salary', 'Pay', 'Compensation']) || '';
            const url = getValue(['Direct URL', 'URL', 'Link', 'Job URL', 'direct_url']) || '';
            
            div.innerHTML = `
                <div class="px-4 py-5 sm:p-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        ${url ? `<a href="${url}" target="_blank" class="text-indigo-600 hover:text-indigo-800">${title}</a>` : title}
                    </h3>
                    <div class="mt-2 max-w-xl text-sm text-gray-500">
                        <p class="font-semibold">${company}</p>
                        <p class="mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${location}</p>
                        ${salary ? `<p class="mt-1"><i class="fas fa-money-bill-wave mr-1"></i>${salary}</p>` : ''}
                        <p class="mt-1"><i class="fas fa-layer-group mr-1"></i>${sheetName}</p>
                        ${description ? `<p class="mt-2 text-sm">${description}</p>` : ''}
                        ${source ? `<p class="mt-1 text-xs text-gray-400"><i class="fas fa-file mr-1"></i>From: ${source}</p>` : ''}
                    </div>
                    <div class="mt-5 flex space-x-3">
                        ${url ? `
                            <a href="${url}" target="_blank" 
                               class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <i class="fas fa-external-link-alt mr-2"></i>View Job
                            </a>
                        ` : ''}
                        <button type="button" 
                                onclick="showApplicationModal('${getValue(['Id', 'ID', 'id']) || index}', '${sheetName}')"
                                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-paper-plane mr-2"></i>Easy Apply
                        </button>
                    </div>
                </div>
            `;
            return div;
        }

        // Show application modal
        function showApplicationModal(jobId, sheetName) {
            selectedJobId = jobId;
            selectedSheetName = sheetName;
            const job = currentJobs[sheetName].find(j => {
                const id = j.Id || j.ID || j.id;
                return id == jobId;
            });
            
            if (!job) {
                console.error('Job not found:', { jobId, sheetName, availableJobs: currentJobs[sheetName] });
                alert('Error: Job not found');
                return;
            }

            const title = getValue(['Title', 'Position', 'Role', 'JobTitle', 'Job Title', 'job_title']) || 'this position';
            const company = getValue(['Company', 'Organization', 'Employer', 'Company Name', 'company_name']) || 'this company';
            
            document.getElementById('modalJobDetails').innerHTML = `
                <div class="space-y-4">
                    <p class="font-medium">Are you sure you want to apply for:</p>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="font-semibold">${title}</p>
                        <p class="text-gray-600">${company}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('applicationModal').classList.remove('hidden');
        }

        // Handle job application
        async function applyForJob() {
            try {
                const response = await fetch('/api/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_id: selectedJobId,
                        sheet_name: selectedSheetName
                    })
                });
                
                const result = await response.json();
                alert(result.message);
                closeModal();
            } catch (error) {
                console.error('Error applying for job:', error);
                alert('Failed to apply for the job. Please try again.');
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('applicationModal').classList.add('hidden');
            selectedJobId = null;
            selectedSheetName = null;
        }

        // Event Listeners
        document.getElementById('sheetFilter').addEventListener('change', (e) => {
            displayJobs(e.target.value);
        });

        document.getElementById('companyFilter').addEventListener('change', (e) => {
            selectedCompany = e.target.value;
            displayJobs(document.getElementById('sheetFilter').value);
        });

        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('confirmApply').addEventListener('click', applyForJob);

        // Initial load
        fetchJobs();
    </script>
</body>
</html> 